<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="moychen">
        <link rel="canonical" href="https://moychen.github.io/moywiki/Golang/Go%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Go内存管理 - MoyWiki</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MoyWiki</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Language <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../CC%2B%2B/Index/" class="dropdown-item">C/C++</a>
</li>
                                    
<li>
    <a href="../Index/" class="dropdown-item">Golang</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/moychen/moywiki" class="nav-link">moychen/moywiki</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#go" class="nav-link">Go内存管理</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">内存分配</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">垃圾回收</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="go"><a class="toclink" href="#go">Go内存管理</a><a class="headerlink" href="#go" title="Permanent link">&para;</a></h1>
<h2 id="_1"><a class="toclink" href="#_1">内存分配</a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2"><a class="toclink" href="#_2">基本概念</a><a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<h4 id="_3"><a class="toclink" href="#_3">逃逸分析</a><a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<h2 id="_4"><a class="toclink" href="#_4">垃圾回收</a><a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="gc"><a class="toclink" href="#gc">gc算法</a><a class="headerlink" href="#gc" title="Permanent link">&para;</a></h3>
<p>原文地址：<strong><a href="https://zhuanlan.zhihu.com/p/338200412?utm_source=ZHShareTargetIDMore&amp;utm_medium=social&amp;utm_oi=710816085917569024">https://zhuanlan.zhihu.com/p/338200412?utm_source=ZHShareTargetIDMore&amp;utm_medium=social&amp;utm_oi=710816085917569024</a></strong></p>
<p>程序中用的到的数据，一定是从栈、数据段这些地方追踪得到的数据。也就是说可以从这些地方直接追踪到的变量作为根节点，可以追踪到数据范围大于等于真正的有用数据。虽然追踪到不表示后面一定会用到，但是追踪不到就一定不会用到，即是无用的垃圾。所以目前主流的垃圾回收算法，都是使用数据“可达性”近似等价于数据有用性的。</p>
<p>STW（stop the world）</p>
<h4 id="-"><a class="toclink" href="#-">标记-清除</a><a class="headerlink" href="#-" title="Permanent link">&para;</a></h4>
<p>标记的过程需要扫描数据段和栈上的数据，把能够直接追踪到的数据作为root，基于这些root进一步追踪，把能追踪到的数据都进行标记，那剩下的没追踪到的就是垃圾了。</p>
<p>**三色抽象**可以清晰的展现追踪过程中数据标记的变化：</p>
<p>（1）垃圾回收开始会把所有数据都标记为白色；</p>
<p>（2）然后把直接追踪到的root节点都标记为灰色，灰色代表基于当前节点展开的追踪还未完成；</p>
<p>（3）当基于某个节点的追踪任务完成后，便会把该节点标记为黑色，表示它是有用数据，而且无需基于它再次进行追踪了。</p>
<p>（4）当没有灰色节点时，就意味着标记工作可以结束了。此时有用数据都为黑色，垃圾都为白色，在清除阶段回收这些白色的垃圾即可。</p>
<p><img alt="img" src="../images/Go%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/v2-c14a9c99f085b1d2b8b8a12efcb81858_b.webp" /></p>
<p>标记清除算法实现起来相对简单，但是比较容易造成内存碎片化，而碎片化会影响内存分配与程序执行的效率。</p>
<p>这一问题，可以配合相应的内存管理模型来缓解。例如Tcmalloc内存管理模型这样，把内存块分成不同的规格进行统一管理，可以很好的应对碎片化问题。还有人提出了标记——压缩（整理）算法。</p>
<p>BiBOP（Big back of pages）</p>
<p><strong>弱三色不变式</strong></p>
<p><strong>强三色不变式</strong></p>
<p><strong>读写屏障</strong></p>
<p>写屏障会在写操作中插入指令，目的就是把数据修改通知垃圾回收器，所以写屏障通常都有一个记录集。</p>
<h4 id="-_1"><a class="toclink" href="#-_1">标记-压缩（整理）</a><a class="headerlink" href="#-_1" title="Permanent link">&para;</a></h4>
<p>标记——压缩算法的标记阶段与标记——清除算法相同，不同的是，它会在完成标记工作后对堆内存的使用进行压缩。所谓的压缩，就是移动非垃圾数据，使它们尽可能紧凑的放在内存中。</p>
<p><img src="images/Go内存管理/v2-1bddf96b1b8561d51616aaa668d165e9_720w.jpg" alt="img" style="zoom: 33%;" /></p>
<p>虽然标记—压缩算法有效解决了内存碎片化的问题，但是带来的多次扫描与移动开销也不容小觑。</p>
<p>标记—压缩算法比较鲜明的特点便是它会移动数据来减少碎片化，还有一种复制式回收算法，也会移动数据。</p>
<h4 id="_5"><a class="toclink" href="#_5">复制式回收</a><a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>（1）复制式回收算法会把堆内存划分成两个相等的空间，From和To。程序执行时使用From空间；</p>
<p>（2）垃圾回收执行时会扫描From空间，把能追踪到的数据复制到To空间。</p>
<p>（3）当所有有用的数据都复制到To空间后，把From和To空间的角色交换一下。原来的To空间用作From，原来的From空间则可以全部回收作为新的To空间。</p>
<p><img alt="img" src="../images/Go%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/v2-675c9f62bfca1bbae9a199d6ad7d4d65_b.webp" /></p>
<p>每一轮垃圾回收都是如此，这种复制式回收也不会带来碎片化问题，而且因着使用连续的内存块，可以实现高速的内存分配。但是明显的不足之处就是只有一半的堆内存可以被使用。</p>
<p>为了提高堆内存的使用率，通常会和其它垃圾回收算法搭配使用，只在一部分堆内存中使用复制式回收。例如在分代回收中就经常搭配使用复制式回收。</p>
<h4 id="_6"><a class="toclink" href="#_6">分代式回收</a><a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>分代回收的提出，主要是基于弱分代假说（weak generational hypothesis）：</p>
<p><strong>“**大部分对象都在年轻时死亡</strong>”**</p>
<p>如果我们把新创建的对象称为“新生代对象”，把经受住特定次数的垃圾回收而依然存活的对象称为“老年代对象”。</p>
<p>基于弱分代假说，新生代对象成为垃圾的概率高于老年代对象，所以可以把数据划分为新生代和老年代，降低老年代执行垃圾回收的频率。</p>
<p>对于标记、复制式等追踪类回收算法而言，不用每次都扫描所有数据，将明显提升垃圾回收执行的效率，而且新生代和老年代还可以分别采用不同的回收策略，进一步提升回收效益并减少开销。</p>
<p>分代回收算法大多通过复制式回收来处理新生代对象，只有经历过一定次数的垃圾回收还能依然存活的新生代对象才会被晋升为老年代对象。虽然分代回收算法将回收的注意力主要集中在新生代对象上，但是考虑到老年代到新生代的引用，也依然做不到只扫描新生代就把回收工作完成的地步。</p>
<p>到目前为止我们介绍的多为追踪式回收，都需要在执行垃圾回收时扫描数据识别垃圾对象，而引用计数式垃圾回收有所不同。</p>
<h4 id="_7"><a class="toclink" href="#_7">引用计数</a><a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>引用计数指的是一个数据对象被引用的次数，程序执行过程中会更新对象及其子对象的引用计数。当引用计数更新到0时，就表示这个对象不再有用，可以回收它占用的内存了。</p>
<p>所以，引用计数法不用专门执行扫描任务，因为垃圾识别的任务已经分摊到每一次对数据对象的操作中了。</p>
<p>这样说起来简单，但实现起来却并不容易。虽然引用计数法可以及时回收无用内存，但是高频率的更新引用计数也会造成不小的开销。而且还要专门想办法识别循环引用的情况，因为循环引用会导致引用计数无法更新到0，造成对应的内存无法被回收的情况。</p>
<p><img src="images/Go内存管理/v2-c6f834936ade78a9f16e16fc0f30ae99_720w.jpg" alt="img" style="zoom:50%;" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021 MoyChen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
