<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="moychen">
        <link rel="canonical" href="https://moychen.github.io/moywiki/Golang/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Go语言是如何启动的 - MoyWiki</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MoyWiki</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Language <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../CC%2B%2B/Index/" class="dropdown-item">C/C++</a>
</li>
                                    
<li>
    <a href="../Index/" class="dropdown-item">Golang</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/moychen/moywiki" class="nav-link">moychen/moywiki</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#go" class="nav-link">Go语言是如何启动的</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">理解可执行文件</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#go_1" class="nav-link">Go进程的启动和初始化</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">调度组件与调度循环</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_8" class="nav-link">处理阻塞</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_11" class="nav-link">与调度有关的常见问题</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="go"><a class="toclink" href="#go">Go语言是如何启动的</a><a class="headerlink" href="#go" title="Permanent link">&para;</a></h1>
<h2 id="_1"><a class="toclink" href="#_1">理解可执行文件</a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2"><a class="toclink" href="#_2">程序构建过程</a><a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<pre class="highlight"><code class="language-bash">$ go build -x go文件  # -x 打印构建详细过程</code></pre>
<pre class="highlight"><code class="language-txt">$ go build -x demo.go
WORK=/tmp/go-build650300936
mkdir -p $WORK/b001/
cat &gt;$WORK/b001/importcfg &lt;&lt; 'EOF' # internal
# import config
packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
EOF
cd /root/moychen/demo
-------------------------------编译-----------------------------------
/usr/local/go/pkg/tool/linux_amd64/compile -o $WORK/b001/_pkg_.a -trimpath "$WORK/b001=&gt;" -p main -complete -buildid IHvcy5J3sPf6q7qSX-yU/IHvcy5J3sPf6q7qSX-yU -goversion go1.15.2 -D _/root/moychen/demo -importcfg $WORK/b001/importcfg -pack ./demo.go
/usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal
cp $WORK/b001/_pkg_.a /root/.cache/go-build/5d/5d735f650ab1e82b957e556236d1f63ac6f76a8dcd5e347a1f7c98d556a8b37f-d # internal
cat &gt;$WORK/b001/importcfg.link &lt;&lt; 'EOF' # internal
packagefile command-line-arguments=$WORK/b001/_pkg_.a
...
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
EOF
mkdir -p $WORK/b001/exe/
cd .
-------------------------------- 链接----------------------------------
/usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=VljoluUulGgW80qhU4WS/IHvcy5J3sPf6q7qSX-yU/CUJ3YEw9E6g_F0Y_-2iM/VljoluUulGgW80qhU4WS -extld=gcc $WORK/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal
mv $WORK/b001/exe/a.out demo
rm -r $WORK/b001/</code></pre>
<h3 id="_3"><a class="toclink" href="#_3">可执行文件</a><a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>可执行文件在不同平台格式规范也不一致。以Linux下ELF（Executable and Linkable Format）为例，详细内容参考<a href="https://github.com/corkami/pics/blob/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101/elf101.pdf[">ELF规范参考文档</a>，ELF文件主要组成部分有：</p>
<blockquote>
<ul>
<li>ELF header</li>
<li>Section header</li>
<li>Sections</li>
</ul>
</blockquote>
<p><img alt="image-20210519180400990" src="../images/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/image-20210519180400990.png" /></p>
<p>如上图所示，通过ELF header中的 entry point 能够找到 Go 进程的执行入口。Linux下运行可执行文件的步骤大致如下：</p>
<pre class="highlight"><code class="language-mermaid">graph LR;
解析ELF-Header --&gt; 加载二进制文件内容至内存 --&gt; 从entry-point开始执行代码;</code></pre>
<h2 id="go_1"><a class="toclink" href="#go_1">Go进程的启动和初始化</a><a class="headerlink" href="#go_1" title="Permanent link">&para;</a></h2>
<p>生成二进制可执行文件后，启动时计算机通过执行二进制机器码指令运行程序，每执行一条语句pc寄存器就指向下一条指令。在 64 位平台上 pc 寄存器 = rip。</p>
<pre class="highlight"><code class="language-go">// demo.go 
package main

import (
    "fmt"
)

func main() {
    fmt.Println("hello world")
}</code></pre>
<p>go build 生成可执行文件demo，然后通过readelf -h demo找到可执行文件demo的entry point找到程序入口，使用dlv调试程序。</p>
<p><img alt="image-20210520210757578" src="../images/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/image-20210520210757578.png" /></p>
<p>中间省略一下没有用的信息。</p>
<p><img alt="image-20210520211303257" src="../images/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/image-20210520211303257.png" /></p>
<p>从上图的结果来看go启动流程大致为：</p>
<pre class="highlight"><code class="language-mermaid">graph TD;
_rt0_amd64_linux --&gt; _rt0_amd64 --&gt; runtime.rt0_go; </code></pre>
<p>runtime.rt0_go中主要工作有：</p>
<pre class="highlight"><code class="language-mermaid">graph LR;
argc/argv处理 --&gt; 全局m0/g0初始化 --&gt; 获取cpu核心数 --&gt; 初始化内部数据结构 --&gt; 开始执行main函数;</code></pre>
<h2 id="_4"><a class="toclink" href="#_4">调度组件与调度循环</a><a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p><strong>G（goroutine）</strong>：⼀个计算任务。由需要执⾏的代码和其上下⽂组成，上下⽂包括：当前代码位置、栈顶、栈底地址、状态等。</p>
<p><strong>M（machine）</strong>：系统线程，执⾏实体，想要在 CPU 上执⾏代码，必须有线程，与 C 语⾔中的线程相同，通过系统调⽤ clone 来创建。</p>
<p><strong>P（processor）</strong>：虚拟处理器，M 必须获得 P 才能执行代码，否则必须陷⼊休眠（后台监控线程除外），你也可以将其理解为⼀种 token，有这个 token，才有在物理 CPU 核心上执行的权利。</p>
<h3 id="_5"><a class="toclink" href="#_5">调度流程</a><a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>Go的调度流程实际上是一个生产-消费流程，当我们新增一个go routine的时候实际上是向runtime 调度组件中新增一个task。</p>
<p><img alt="image-20210521163354177" src="../images/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/image-20210521163354177.png" /></p>
<h3 id="_6"><a class="toclink" href="#_6">生产者</a><a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p><img src="images/Go程序是如何启动的/image-20210521165029181.png" alt="image-20210521165029181" style="zoom:67%;" /></p>
<h3 id="_7"><a class="toclink" href="#_7">消费者</a><a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p><img alt="image-20210521165214744" src="../images/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/image-20210521165214744.png" /></p>
<blockquote>
<ul>
<li>M 执⾏调度循环时，必须与⼀个 P 绑定</li>
<li>Work stealing 就是说的 runqsteal -&gt; runqgrab 这个流程</li>
</ul>
</blockquote>
<p><img src="images/Go程序是如何启动的/image-20210521165441266.png" alt="image-20210521165441266" style="zoom: 50%;" /></p>
<h2 id="_8"><a class="toclink" href="#_8">处理阻塞</a><a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>Go中阻塞大概有这么几种场景：</p>
<blockquote>
<ul>
<li>channel send/recv</li>
<li>sleep</li>
<li>select</li>
<li>lock</li>
<li>网络IO</li>
</ul>
</blockquote>
<p>当上述阻塞场景之一发生时，Go会将该goroutine挂起，不会阻塞Go的调度流程。挂起指的是调度组件会将该goroutine放入等待队列，待可执行时，待ready后再继续执行，不会占用线程。</p>
<h3 id="_9"><a class="toclink" href="#_9">可拦截的阻塞</a><a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<h4 id="channel-sendrecv"><a class="toclink" href="#channel-sendrecv">channel send/recv</a><a class="headerlink" href="#channel-sendrecv" title="Permanent link">&para;</a></h4>
<h4 id="timesleep"><a class="toclink" href="#timesleep">time.Sleep</a><a class="headerlink" href="#timesleep" title="Permanent link">&para;</a></h4>
<h4 id="select"><a class="toclink" href="#select">select</a><a class="headerlink" href="#select" title="Permanent link">&para;</a></h4>
<h4 id="lock"><a class="toclink" href="#lock">lock</a><a class="headerlink" href="#lock" title="Permanent link">&para;</a></h4>
<h4 id="io"><a class="toclink" href="#io">网络IO</a><a class="headerlink" href="#io" title="Permanent link">&para;</a></h4>
<h3 id="_10"><a class="toclink" href="#_10">不可拦截的阻塞</a><a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<blockquote>
<ul>
<li>cgo</li>
<li>syscall 系统调用</li>
<li>⻓时间运⾏需要剥离 P 执⾏</li>
</ul>
</blockquote>
<h3 id="sysmon"><a class="toclink" href="#sysmon">sysmon</a><a class="headerlink" href="#sysmon" title="Permanent link">&para;</a></h3>
<p>sysmon是runtime中的system monitor，具有高优先级，在专有线程中执行，并且不需要绑定P。</p>
<p>checkdead：常见误解—这个可以检查死锁</p>
<p>netpoll：inject g list to global run queue</p>
<p>retake：如果syscall卡了很久，就把剥离（handoff p）</p>
<p>​               如果用户g运行很久，那么发信号SIGURG抢占</p>
<h2 id="_11"><a class="toclink" href="#_11">与调度有关的常见问题</a><a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021 MoyChen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
