
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="moychen">
      
      
        <link rel="canonical" href="https://moychen.github.io/moywiki/CC%2B%2B/MallocInternals/">
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.4">
    
    
      
        <title>Malloc Internals - MoyWiki</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#malloc-internals" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MoyWiki" class="md-header__button md-logo" aria-label="MoyWiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MoyWiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Malloc Internals
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red" type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/moychen/moywiki" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    moychen/moywiki
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Language
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MoyWiki" class="md-nav__button md-logo" aria-label="MoyWiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    MoyWiki
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/moychen/moywiki" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    moychen/moywiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Language
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      <label class="md-nav__link" for="__nav_2_1">
        C/C++
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="C/C++" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          C/C++
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Malloc Internals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Malloc Internals
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-malloc" class="md-nav__link">
    Overview of Malloc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-a-chunk" class="md-nav__link">
    What is a Chunk?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arenas-and-heaps" class="md-nav__link">
    Arenas and Heaps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-local-cache-tcache" class="md-nav__link">
    Thread Local Cache (tcache)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#malloc-algorithm" class="md-nav__link">
    Malloc Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#free-algorithm" class="md-nav__link">
    Free Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realloc-algorithm" class="md-nav__link">
    Realloc Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switching-arenas" class="md-nav__link">
    Switching arenas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-specific-thresholds-and-constants" class="md-nav__link">
    Platform-specific Thresholds and Constants
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tbd" class="md-nav__link">
    TBD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#colophon" class="md-nav__link">
    Colophon
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Golang
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Golang" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../Golang/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/" class="md-nav__link">
        Go程序是如何启动的
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-malloc" class="md-nav__link">
    Overview of Malloc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-a-chunk" class="md-nav__link">
    What is a Chunk?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arenas-and-heaps" class="md-nav__link">
    Arenas and Heaps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thread-local-cache-tcache" class="md-nav__link">
    Thread Local Cache (tcache)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#malloc-algorithm" class="md-nav__link">
    Malloc Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#free-algorithm" class="md-nav__link">
    Free Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realloc-algorithm" class="md-nav__link">
    Realloc Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switching-arenas" class="md-nav__link">
    Switching arenas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-specific-thresholds-and-constants" class="md-nav__link">
    Platform-specific Thresholds and Constants
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tbd" class="md-nav__link">
    TBD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#colophon" class="md-nav__link">
    Colophon
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="malloc-internals">Malloc Internals<a class="headerlink" href="#malloc-internals" title="Permanent link">&para;</a></h1>
<h2 id="overview-of-malloc">Overview of Malloc<a class="headerlink" href="#overview-of-malloc" title="Permanent link">&para;</a></h2>
<p>The GNU C library's (glibc's) malloc library contains a handful of functions that manage allocated memory in the application's address space. The glibc malloc is derived from ptmalloc (pthreads malloc), which is derived from dlmalloc (Doug Lea malloc). This malloc is a "heap" style malloc, which means that chunks of various sizes exist within a larger region of memory (a "heap") as opposed to, for example, an implementation that uses bitmaps and arrays, or regions of same-sized blocks, etc. In ancient times, there was one heap per application, but glibc's malloc allows for multiple heaps, each of which grows within its address space.</p>
<p>Thus, within this document, we refer to some common terms:</p>
<ul>
<li>Arena</li>
</ul>
<p>A structure that is shared among one or more threads which contains references to one or more heaps, as well as linked lists of chunks within those heaps which are "free". Threads assigned to each arena will allocate memory from that arena's free lists.</p>
<ul>
<li>Heap</li>
</ul>
<p>A contiguous region of memory that is subdivided into chunks to be allocated. Each heap belongs to exactly one arena.</p>
<ul>
<li>Chunk</li>
</ul>
<p>A small range of memory that can be allocated (owned by the application), freed (owned by glibc), or combined with adjacent chunks into larger ranges. Note that a chunk is a wrapper around the block of memory that is given to the application. Each chunk exists in one heap and belongs to one arena.</p>
<ul>
<li>Memory</li>
</ul>
<p>A portion of the application's address space which is typically backed by RAM or swap.</p>
<p>Note that, in this document, we only refer to "memory" as a generic term. While there is some code in glibc's malloc to work with the Linux kernel (or other OS) to hint at what memory should be mapped/backed and what can be returned to the kernel, such discrimination between "real memory" and "virtual memory" is irrelevant to the discussion herein, unless explicitly called out.</p>
<h2 id="what-is-a-chunk">What is a Chunk?<a class="headerlink" href="#what-is-a-chunk" title="Permanent link">&para;</a></h2>
<p>Glibc's malloc is chunk-oriented. It divides a large region of memory (a "heap") into chunks of various sizes. Each chunk includes meta-data about how big it is (via a <code>size</code> field in the chunk header), and thus where the adjacent chunks are. When a chunk is in use by the application, the only data that's "remembered" is the size of the chunk. When the chunk is free'd, the memory that used to be application data is re-purposed for additional arena-related information, such as pointers within linked lists, such that suitable chunks can quickly be found and re-used when needed. Also, the last word in a free'd chunk contains a copy of the chunk size (with the three LSBs set to zeros, vs the three LSBs of the size at the front of the chunk which are used for flags).</p>
<p>Within the malloc library, a "chunk pointer" or <em>mchunkptr</em> does <em>not</em> point to the beginning of the chunk, but to the last word in the previous chunk - i.e. the first field in <code>mchunkptr</code> is not valid unless you know the previous chunk is free.</p>
<p>Since all chunks are multiples of 8 bytes, the 3 LSBs of the chunk size can be used for flags. These three flags are defined as follows:</p>
<ul>
<li>A (0x04)</li>
</ul>
<p>Allocated Arena - the main arena uses the application's heap. Other arenas use mmap'd heaps. To map a chunk to a heap, you need to know which case applies. If this bit is 0, the chunk comes from the main arena and the main heap. If this bit is 1, the chunk comes from mmap'd memory and the location of the heap can be computed from the chunk's address.</p>
<ul>
<li>M (0x02)</li>
</ul>
<p>MMap'd chunk - this chunk was allocated with a single call to <code>mmap</code> and is not part of a heap at all.</p>
<ul>
<li>P (0x01)</li>
</ul>
<p>Previous chunk is in use - if set, the previous chunk is still being used by the application, and thus the <code>prev_size</code> field is invalid. Note - some chunks, such as those in fastbins (see below) will have this bit set despite being free'd by the application. This bit really means that the previous chunk should not be considered a candidate for coalescing - it's "in use" by either the application or some other optimization layered atop malloc's original code <img alt=":-)" src="https://sourceware.org/moin_static1910/modern/img/smile.png" /></p>
<p>In order to ensure that a chunk's payload area is large enough to hold the overhead needed by malloc, the minimum size of a chunk is <code>4*sizeof(void*)</code> (unless <code>size_t</code> is not the same size as <code>void*</code>). The minimum size may be larger if the ABI of the platform requires additional alignment. Note that <code>prev_size</code> does not increase the minimum chunk size to <code>5*sizeof(void*)</code> because when the chunk is small the <code>bk_nextsize</code> pointer is unused, and when the chunk is large enough to use it there is more than enough space at the end.</p>
<table>
<thead>
<tr>
<th>In-use Chunk</th>
<th>Free Chunk</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Note that, since chunks are adjacent to each other in memory, if you know the address of the first chunk (lowest address) in a heap, you can iterate through all the chunks in the heap by using the size information, but only by increasing address, although it may be difficult to detect when you've hit the last chunk in the heap.</p>
<p>Allocated heaps are always aligned to a power-of-two address. Thus, when a chunk is in an allocated heap (i.e. the A bit is set), the address of the <code>heap_info</code> for that heap can be computed based on the address of the chunk:</p>
<table>
<thead>
<tr>
<th>Chunk to Heap</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="arenas-and-heaps">Arenas and Heaps<a class="headerlink" href="#arenas-and-heaps" title="Permanent link">&para;</a></h2>
<p>In order to efficiently handle multi-threaded applications, glibc's malloc allows for more than one region of memory to be active at a time. Thus, different threads can access different regions of memory without interfering with each other. These regions of memory are collectively called "arenas". There is one arena, the "main arena", that corresponds to the application's initial heap. There's a static variable in the malloc code that points to this arena, and each arena has a <code>next</code> pointer to link additional arenas.</p>
<p>As pressure from thread collisions increases, additional arenas are created via <code>mmap</code> to relieve the pressure. The number of arenas is capped at eight times the number of CPUs in the system (unless the user specifies otherwise, see <code>mallopt</code>), which means a heavily threaded application will still see some contention, but the trade-off is that there will be less fragmentation.</p>
<p>Each arena structure has a mutex in it which is used to control access to that arena. Note that some operations, such as access to the fastbins, can be done with atomic operations and do not need to lock the arena. All other operations require that the thread take a lock on the arena. Contention for this mutex is the reason why multiple arenas are created - threads assigned to different arenas need not wait for each other. Threads will automatically switch to unused (unlocked) arenas if contention requires it.</p>
<p>Each arena obtains memory from one or more heaps. The main arena uses the program's initial heap (starting right after .bss et al). Additional arenas allocate memory for their heaps via mmap, adding more heaps to their list of heaps as older heaps are used up. Each arena keeps track of a special "top" chunk, which is typically the biggest available chunk, and also refers to the most recently allocated heap.</p>
<p>Memory for allocated arenas is, conveniently, taken from the initial heap for that arena:</p>
<table>
<thead>
<tr>
<th>Heaps and Arenas</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Within each arena, chunks are either in use by the application or they're free (available). In-use chunks are not tracked by the arena. Free chunks are stored in various lists based on size and history, so that the library can quickly find suitable chunks to satisfy allocation requests. The lists, called "bins", are:</p>
<ul>
<li>Fast</li>
</ul>
<p>Small chunks are stored in size-specific bins. Chunks added to a fast bin ("fastbin") are not combined with adjacent chunks - the logic is minimal to keep access fast (hence the name). Chunks in the fastbins may be moved to other bins as needed. Fastbin chunks are stored in a single linked list, since they're all the same size and chunks in the middle of the list need never be accessed.</p>
<ul>
<li>Unsorted</li>
</ul>
<p>When chunks are free'd they're initially stored in a single bin. They're sorted later, in malloc, in order to give them one chance to be quickly re-used. This also means that the sorting logic only needs to exist at one point - everyone else just puts free'd chunks into this bin, and they'll get sorted later. The "unsorted" bin is simply the first of the regular bins.</p>
<ul>
<li>Small</li>
</ul>
<p>The normal bins are divided into "small" bins, where each chunk is the same size, and "large" bins, where chunks are a range of sizes. When a chunk is added to these bins, they're first combined with adjacent chunks to "coalesce" them into larger chunks. Thus, these chunks are never adjacent to other such chunks (although they may be adjacent to fast or unsorted chunks, and of course in-use chunks). Small and large chunks are doubly-linked so that chunks may be removed from the middle (such as when they're combined with newly free'd chunks).</p>
<ul>
<li>Large</li>
</ul>
<p>A chunk is "large" if its bin may contain more than one size. For small bins, you can pick the first chunk and just use it. For large bins, you have to find the "best" chunk, and possibly split it into two chunks (one the size you need, and one for the remainder).</p>
<table>
<thead>
<tr>
<th>Free, Unsorted, Small, and Large Bin Chains</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Note: in the diagram above (and below), all the pointers are to a "chunk" (<code>mchunkptr</code>). Since the bins are not chunks (they're arrays of <code>fwd</code>/<code>bck</code> pointers), a hack is used to provide an <code>mchunkptr</code> to a chunk-like object which overlaps the bins "just right" so that the <code>mchunkptr</code>'s <code>fwd</code> and <code>bck</code> fields can be used to access the appropriate bin.</p>
<p>Because of the need to find the "best" fit for large chunks, large chunks have an additional doubly-linked list linking the first of each size in the list, and chunks are sorted by size, largest through smallest. This allows malloc to quickly scan for the first chunk that's big enough. Note: if multiple chunks of a given size are present, the <em>second</em> one is typically the chosen one, so that the next-size linked list need not be adjusted. Chunks inserted into the list are added after a chunk of the same size, for the same reason.</p>
<table>
<thead>
<tr>
<th>Large Bin "Next Size" Chains</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="thread-local-cache-tcache">Thread Local Cache (tcache)<a class="headerlink" href="#thread-local-cache-tcache" title="Permanent link">&para;</a></h2>
<p>While this malloc is aware of multiple threads, that's pretty much the extent of its awareness - it knows there are multiple threads. There is no code in this malloc to optimize it for NUMA architectures, coordinate thread locality, sort threads by core, etc. It is assumed that the kernel will handle those issues sufficiently well.</p>
<p>Each thread has a thread-local variable that remembers which arena it last used. If that arena is in use when a thread needs to use it the thread will block to wait for the arena to become free. If the thread has never used an arena before then it may try to reuse an unused one, create a new one, or pick the next one on the global list.</p>
<p>Each thread has a per-thread cache (called the <em>tcache</em>) containing a small collection of chunks which can be accessed without needing to lock an arena. These chunks are stored as an array of singly-linked lists, like fastbins, but with links pointing to the payload (user area) not the chunk header. Each bin contains one size chunk, so the array is indexed (indirectly) by chunk size. Unlike fastbins, the tcache is limited in how many chunks are allowed in each bin (<code>tcache_count</code>). If the tcache bin is empty for a given requested size, the next larger sized chunk is not used (could cause internal fragmentation), instead the fallback is to use the normal malloc routines i.e. locking the thread's arena and working from there.</p>
<table>
<thead>
<tr>
<th>Per-thread Cache (tcache)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="malloc-algorithm">Malloc Algorithm<a class="headerlink" href="#malloc-algorithm" title="Permanent link">&para;</a></h2>
<p>In a nutshell, malloc works like this:</p>
<ul>
<li>If there is a suitable (exact match only) chunk in the tcache, it is returned to the caller. No attempt is made to use an available chunk from a larger-sized bin.</li>
<li>If the request is large enough, <code>mmap()</code> is used to request memory directly from the operating system. Note that the threshold for mmap'ing is dynamic, unless overridden by M_MMAP_THRESHOLD (see mallopt() documentation), and there may be a limit to how many such mappings there can be at one time.</li>
<li>If the appropriate fastbin has a chunk in it, use that. If additional chunks are available, also pre-fill the tcache.</li>
<li>If the appropriate smallbin has a chunk in it, use that, possibly pre-filling the tcache here also.</li>
<li>If the request is "large", take a moment to take everything in the fastbins and move them to the unsorted bin, coalescing them as you go.</li>
<li>Start taking chunks off the unsorted list, and moving them to small/large bins, coalescing as you go (note that this is the only place in the code that puts chunks into the small/large bins). If a chunk of the right size is seen, use that.</li>
<li>If the request is "large", search the appropriate large bin, and successively larger bins, until a large-enough chunk is found.</li>
<li>If we still have chunks in the fastbins (this may happen for "small" requests), consolidate those and repeat the previous two steps.</li>
<li>Split off part of the "top" chunk, possibly enlarging "top" beforehand.</li>
</ul>
<p>For an over-aligned malloc, such as <code>valloc</code>, <code>pvalloc</code>, or <code>memalign</code>, an overly-large chunk is located (using the malloc algorithm above) and divided into two or more chunks in such a way that most of the chunk is now suitably aligned (and returned to the caller), and the excess before and after that portion is returned to the unsorted list to be re-used later.</p>
<h2 id="free-algorithm">Free Algorithm<a class="headerlink" href="#free-algorithm" title="Permanent link">&para;</a></h2>
<p>Note that, in general, "freeing" memory does not actually return it to the operating system for other applications to use. The <code>free()</code> call marks a chunk of memory as "free to be reused" by the application, but from the operating system's point of view, the memory still "belongs" to the application. However, if the top chunk in a heap - the portion adjacent to unmapped memory - becomes large enough, some of that memory may be unmapped and returned to the operating system.</p>
<p>In a nutshell, free works like this:</p>
<ul>
<li>If there is room in the tcache, store the chunk there and return.</li>
<li>If the chunk is small enough, place it in the appropriate fastbin.</li>
<li>If the chunk was mmap'd, munmap it.</li>
<li>See if this chunk is adjacent to another free chunk and coalesce if it is.</li>
<li>Place the chunk in the unsorted list, unless it's now the "top" chunk.</li>
<li>If the chunk is large enough, coalesce any fastbins and see if the top chunk is large enough to give some memory back to the system. Note that this step might be deferred, for performance reasons, and happen during a malloc or other call.</li>
</ul>
<h2 id="realloc-algorithm">Realloc Algorithm<a class="headerlink" href="#realloc-algorithm" title="Permanent link">&para;</a></h2>
<p>Note that realloc of NULL and realloc to zero size are handled separately and as per the relevant specs.</p>
<p>In a nutshell, realloc works like this:</p>
<p><em>For MMAP'd chunks...</em></p>
<p>Allocations that are serviced via individual <code>mmap</code> calls (i.e. large ones) are realloc'd by <code>mremap()</code> if available, which may or may not result in the new memory being at a different address than the old memory, depending on what the kernel does.</p>
<p>If the system does not support <code>munmap()</code> and the new size is smaller than the old size, nothing happens and the old address is returned, else a malloc-copy-free happens.</p>
<p><em>For arena chunks...</em></p>
<ul>
<li>If the size of the allocation is being reduced by enough to be "worth it", the chunk is split into two chunks. The first half (which has the old address) is returned, and the second half is returned to the arena as a free chunk. Slight reductions are treated as "the same size".</li>
<li>If the allocation is growing, the next (adjacent) chunk is checked. If it is free, or the "top" block (representing the expandable part of the heap), and large enough, then that chunk and the current are merged, producing a large-enough block which can be possibly split (as above). In this case, the old pointer is returned.</li>
<li>If the allocation is growing and there's no way to use the existing/following chunk, then a malloc-copy-free sequence is used.</li>
</ul>
<h2 id="switching-arenas">Switching arenas<a class="headerlink" href="#switching-arenas" title="Permanent link">&para;</a></h2>
<p>The arena to which a thread is attached is generally viewed as an invariant that does not change over the lifetime of the process. This invariant, while useful for explaining general concepts, is not true. The scenario for changing arenas looks like this:</p>
<ul>
<li>Thread fails to allocate memory from the attached arena.</li>
<li>Assumes we tried coalescing, searched free list, processed unsorted list etc.</li>
<li>Assumes we tried to expand the heap but either the <code>sbrk</code> failed or creating the new mapping failed.</li>
<li>If previously using a non-main arena with <code>mmap</code>'d heaps the thread is switched via <code>arena_get_retry</code> to the main arena with an <code>sbrk</code>-based heap, or switched to non-main arena (from free list or a new one) if previously using the main arena. As an optimization this is not done if the process is single threaded, and we fail at this point returning <code>ENOMEM</code> (it is assumed that if <code>sbrk</code> did not work, and we tried <code>mmap</code> to extend the main arena, that a non-main arena will not work either).</li>
</ul>
<p>Note that a thread may change frequently between arenas in low-memory conditions, switching from main-arena which <code>sbrk</code>-based to a non-main arena which is <code>mmap</code>-based, all in an attempt to find a heap with enough space to satisfy the allocation.</p>
<h2 id="platform-specific-thresholds-and-constants">Platform-specific Thresholds and Constants<a class="headerlink" href="#platform-specific-thresholds-and-constants" title="Permanent link">&para;</a></h2>
<p>These values are provided for entertainment purposes only, and are not guarateed to be correct, but they should have been at one point, at least in general.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>32 bit</th>
<th>i386</th>
<th>64 bit</th>
</tr>
</thead>
<tbody>
<tr>
<td>MALLOC_ALIGNMENT</td>
<td>8</td>
<td>16</td>
<td>16</td>
</tr>
<tr>
<td>MIN_CHUNK_SIZE</td>
<td>16</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>MAX_FAST_SIZE</td>
<td>80</td>
<td>80</td>
<td>160</td>
</tr>
<tr>
<td>MAX_TCACHE_SIZE</td>
<td>516</td>
<td>1,020</td>
<td>1,032</td>
</tr>
<tr>
<td>MIN_LARGE_SIZE</td>
<td>512</td>
<td>1,008</td>
<td>1,024</td>
</tr>
<tr>
<td>DEFAULT_MMAP_THRESHOLD</td>
<td>131,072</td>
<td>131,072</td>
<td>131,072</td>
</tr>
<tr>
<td>DEFAULT_MMAP_THRESHOLD_MAX</td>
<td>524,288</td>
<td>524,288</td>
<td>33,554,432</td>
</tr>
<tr>
<td>HEAP_MIN_SIZE</td>
<td>32,768</td>
<td>32,768</td>
<td>32,768</td>
</tr>
<tr>
<td>HEAP_MAX_SIZE</td>
<td>1,048,576</td>
<td>1,048,576</td>
<td>67,108,864</td>
</tr>
</tbody>
</table>
<h2 id="tbd">TBD<a class="headerlink" href="#tbd" title="Permanent link">&para;</a></h2>
<ul>
<li>Tunables</li>
<li>Remainder of API calls</li>
</ul>
<h2 id="colophon">Colophon<a class="headerlink" href="#colophon" title="Permanent link">&para;</a></h2>
<p>The images in this document were created with <a href="https://sourceware.org/glibc/wiki/LibreOffice">LibreOffice</a> Draw. For each *.svg file, there is a *.odg file which is the source.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../.." class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        <a href="../../Golang/Go%E7%A8%8B%E5%BA%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E7%9A%84/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Go程序是如何启动的
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021 MoyChen
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.tabs"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.4fa0e4ee.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.1d3bfcf1.min.js"></script>
      
    
  </body>
</html>